<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Credit Limit Form</title>
  <style>
    body {
      font-family: Arial;
      max-width: 600px;
      margin: 20px auto;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
    }
    label {
      font-weight: bold;
    }
    button {
      background: teal;
      color: white;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Credit Limit Form</h2>
  <form id="creditForm">
    <label>Client Name</label>
    <input list="clients" name="clientName" id="clientName" required>
    <datalist id="clients"></datalist>

    <label>State</label>
    <select id="state" required></select>

    <label>Station</label>
    <select id="station" required></select>

    <label>New Credit Limit</label>
    <input type="number" id="newCreditLimit" required>

    <label>Remark</label>
    <textarea id="remark"></textarea>

    <div id="yatharthSection" style="display:none;">
      <label>Yatharth Sir Sign Image Link</label>
      <input type="text" id="yatharthLink">
    </div>

    <div id="siddhartSection" style="display:none;">
      <label>Siddhart Sir Sign Image Link</label>
      <input type="text" id="siddhartLink">
    </div>

    <button type="submit">Submit</button>
  </form>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycbwDjNfSM9kxNx8vlYwjhKG2mnCshlbIU_nb2qyx3CAJ7xl-DPvnd6PzVC19V5k-SpSI/exec";

    async function fetchData(endpoint, params = {}) {
      const url = new URL(API_BASE);
      url.searchParams.set("action", endpoint);
      for (const key in params) {
        url.searchParams.set(key, params[key]);
      }
      const res = await fetch(url);
      return await res.json();
    }

    function $(id) {
      return document.getElementById(id);
    }

    async function loadFormData() {
      const { clients, states } = await fetchData("getFormData");
      clients.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        $("clients").appendChild(opt);
      });
      states.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        $("state").appendChild(opt);
      });
    }

    $("state").addEventListener("change", async () => {
      const state = $("state").value;
      $("station").innerHTML = "";
      if (state) {
        const stations = await fetchData("getStationsByState", { state });
        stations.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          $("station").appendChild(opt);
        });
      }
    });

    $("newCreditLimit").addEventListener("input", async () => {
      const client = $("clientName").value;
      const state = $("state").value;
      const newLimit = parseFloat($("newCreditLimit").value);
      if (client && state && !isNaN(newLimit)) {
        const currentLimit = parseFloat(await fetchData("getCurrentLimit", { clientName: client, state }));
        $("yatharthSection").style.display = (currentLimit > 0 && newLimit >= currentLimit * 1.3) ? "block" : "none";
        $("siddhartSection").style.display = (newLimit >= 450000) ? "block" : "none";
      }
    });

    $("creditForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = {
        clientName: $("clientName").value,
        state: $("state").value,
        station: $("station").value,
        newCreditLimit: parseFloat($("newCreditLimit").value),
        remark: $("remark").value,
        yatharthLink: $("yatharthLink").value,
        siddhartLink: $("siddhartLink").value
      };

      await fetch(API_BASE, {
        method: "POST",
        body: JSON.stringify({ action: "submitForm", ...data }),
        headers: { "Content-Type": "application/json" }
      });

      alert("Form submitted!");
      $("creditForm").reset();
      $("station").innerHTML = "";
      $("yatharthSection").style.display = "none";
      $("siddhartSection").style.display = "none";
    });

    loadFormData();
  </script>
</body>
</html>
